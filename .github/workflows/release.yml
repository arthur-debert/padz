name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Extract release notes from CHANGELOG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Extract section for this version (between ## [VERSION] and next ## [)
          awk '/^## \['"$VERSION"'\]/{found=1; next} /^## \[/{if(found) exit} found{print}' CHANGELOG.md > release-notes.md
          # If empty, provide fallback
          if [ ! -s release-notes.md ]; then
            echo "Release v$VERSION" > release-notes.md
          fi
          echo "=== Release Notes ==="
          cat release-notes.md

      - uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md

  publish:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set version from tag
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          echo "Setting version to $VERSION"
          # Update workspace version
          sed -i 's/^version = ".*"/version = "'"$VERSION"'"/' Cargo.toml
          # Update padzapp dependency version in padz crate
          sed -i 's/padzapp = { version = "[^"]*"/padzapp = { version = "'"$VERSION"'"/' crates/padz/Cargo.toml
          echo "=== Root Cargo.toml ==="
          grep "^version" Cargo.toml
          echo "=== padz/Cargo.toml padzapp dep ==="
          grep "padzapp" crates/padz/Cargo.toml
          cargo update -w

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml Cargo.lock crates/padz/Cargo.toml
          git commit -m "chore: bump version to ${{ needs.prepare.outputs.version }}"
          git push origin HEAD:main

      - name: Publish padzapp to crates.io
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          cargo publish --token ${{ secrets.CRATES_IO_KEY }} -p padzapp 2>&1 || {
            if cargo search padzapp --limit 1 2>/dev/null | grep -q "padzapp.*\"$VERSION\""; then
              echo "padzapp@$VERSION already published, skipping"
            else
              echo "Failed to publish padzapp"
              exit 1
            fi
          }

      - name: Wait for crates.io index update
        run: sleep 30

      - name: Publish padz to crates.io
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          cargo publish --token ${{ secrets.CRATES_IO_KEY }} -p padz 2>&1 || {
            if cargo search padz --limit 1 2>/dev/null | grep -q "padz.*\"$VERSION\""; then
              echo "padz@$VERSION already published, skipping"
            else
              echo "Failed to publish padz"
              exit 1
            fi
          }

  release:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: release-notes

      - name: Create GitHub Release (draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: v${{ needs.prepare.outputs.version }}
          body_path: release-notes.md
          draft: true

  build-binaries:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact: padz-aarch64-apple-darwin
            cross: false
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: padz-x86_64-linux-gnu
            cross: false
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: padz-aarch64-linux-gnu
            cross: true
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set version from tag
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' 's/^version = ".*"/version = "'"$VERSION"'"/' Cargo.toml
            sed -i '' 's/padzapp = { version = "[^"]*"/padzapp = { version = "'"$VERSION"'"/' crates/padz/Cargo.toml
          else
            sed -i 's/^version = ".*"/version = "'"$VERSION"'"/' Cargo.toml
            sed -i 's/padzapp = { version = "[^"]*"/padzapp = { version = "'"$VERSION"'"/' crates/padz/Cargo.toml
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build binary
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} -p padz
          else
            cargo build --release --target ${{ matrix.target }} -p padz
          fi

      - name: Package binary
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/padz dist/${{ matrix.artifact }}
          cd dist
          tar -czvf ../${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.tar.gz

  finalize:
    needs: [prepare, release, build-binaries, publish]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: padz-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la

      - name: Attach binaries and publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          files: padz-*.tar.gz
          draft: false
