#!/usr/bin/env bash
set -euo pipefail

# Build output directory (matching main build script)
BIN_DIR="bin"
MAN_DIR="man/man1"

# Create man directory
mkdir -p "${MAN_DIR}"

# Always build for the current platform to ensure compatibility
if [ ! -f "${BIN_DIR}/padz" ]; then
    echo "Building padz for current platform..."
    ./scripts/build
fi

# Build the man page generator tool
echo "Building padz-manpage tool..."
go build -o "${BIN_DIR}/padz-manpage" ./cmd/padz-manpage

# Generate man page
echo "Generating man page..."
"${BIN_DIR}/padz-manpage" > "${MAN_DIR}/padz.1"

# Compress the man page
if [ -f "${MAN_DIR}/padz.1" ]; then
    gzip -f "${MAN_DIR}/padz.1"
    echo "✅ Man page generated in ${MAN_DIR}/padz.1.gz"
else
    echo "❌ Failed to generate man page"
    exit 1
fi