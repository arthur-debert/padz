#!/usr/bin/env zsh
# Script wrapper for batch execution
# Reads a script file and executes each command, showing output

# Don't exit on errors - we want to show all command outputs
setopt no_err_exit

# Wrapper function for padz
padz() {
    __PADZ_BIN__ "$@"
}

# Convenience alias
alias pa='padz'

# Colors
GRAY=$'\033[38;5;245m'
NC=$'\033[0m'

# Change to workspace
cd "__WORKSPACE__"

# Read entire script into array first to avoid stdin consumption issues
# (some commands like padz may read from stdin, consuming the script file)
lines=("${(@f)$(cat "$1")}")

prev_was_comment=false
for line in "${lines[@]}"; do
    # Handle comments - display them in gray
    if [[ "$line" =~ '^[[:space:]]*#' ]]; then
        # Extract comment text after # and leading whitespace
        comment_text=$(echo "$line" | sed 's/^[[:space:]]*#[[:space:]]*//')
        if [[ -n "$comment_text" ]]; then
            [[ "$prev_was_comment" == false ]] && echo
            echo "${GRAY}${comment_text}${NC}"
        fi
        prev_was_comment=true
        continue
    fi

    # Skip empty lines
    if [[ -z "$line" ]]; then
        prev_was_comment=false
        continue
    fi

    # Echo and execute command (redirect stdin from /dev/null to prevent
    # commands from consuming script input)
    echo
    echo "${GRAY}$ ${line}${NC}"
    eval "$line" </dev/null
    prev_was_comment=false
done
